import os
from datetime import datetime
from telegram import Update
from telegram.ext import ContextTypes
from utils.google_sheets import append_to_sheet
from utils.voice_tools import synthesize_and_send
from openai import AsyncOpenAI

# –°–æ–∑–¥–∞—ë–º OpenAI-–∫–ª–∏–µ–Ω—Ç –æ–¥–∏–Ω —Ä–∞–∑
client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# –ü–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç Holla English —Å 13 —à–∞–≥–∞–º–∏
HOLLA_PROMPT = """
–¢—ã –∞–º–µ—Ä–∏–∫–∞–Ω–µ—Ü-–Ω–æ—Å–∏—Ç–µ–ª—å —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ. –£ —Ç–µ–±—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã CELTA, TOEFL, IELTS ‚Äî —Å–¥–∞–Ω—ã –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã. –¢—ã –æ–±—ä—è—Å–Ω—è–µ—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Ç–∞–∫, —á—Ç–æ–±—ã —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ –º–æ–≥–ª–∏ –ª–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å, –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–ª–æ–≤–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–µ.

–†–∞–∑–±–µ—Ä–∏ —Å–ª–æ–≤–æ: "{word}"

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å 13 –ø—É–Ω–∫—Ç–∞–º–∏:

1. –ü—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º) ‚Äî 1‚Äì2 –∫–ª—é—á–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è. –ï—Å–ª–∏ —ç—Ç–æ –≥–ª–∞–≥–æ–ª, –¥–æ–±–∞–≤—å *to*.

2. –ë–ª–∏–∂–∞–π—à–∏–µ –∞–Ω–∞–ª–æ–≥–∏ –≤ —Ä—É—Å—Å–∫–æ–º ‚Äî —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É", "–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∫–æ–º—É-—Ç–æ").

3. –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å ‚Äî –∫–æ–≥–¥–∞ –∏ –∑–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ —Å–ª–æ–≤–æ. –£–∫–∞–∂–∏ 3‚Äì5 —Å–∏—Ç—É–∞—Ü–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–∏–º–µ—Ä –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.

4. –ö–æ–≥–¥–∞ –ù–ï —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî —É–∫–∞–∂–∏ ‚ùå —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –ø—É—Ç–∞–Ω–∏—Ü—É —Å–æ —Å—Ö–æ–∂–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.

5. –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ-–Ω–æ—Å–∏—Ç–µ–ª–µ–π ‚Äî —Ç–æ–∂–µ —Å ‚ùå –∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏.

6. –§–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ / –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ / —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ.

7. –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è ‚Äî –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä: [ r…™Ààz…™lj…ônt ]

8. CEFR —É—Ä–æ–≤–µ–Ω—å (A1‚ÄìC2), —á–∞—Å—Ç—å —Ä–µ—á–∏, —Ñ–æ—Ä–º—ã —Å–ª–æ–≤–∞:
   - –µ—Å–ª–∏ –≥–ª–∞–≥–æ–ª: 3 —Ñ–æ—Ä–º—ã + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
   - –µ—Å–ª–∏ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Å—Ç–µ–ø–µ–Ω–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
   - –∫–∞–∫–∏–µ –ø—Ä–µ–¥–ª–æ–≥–∏ —á–∞—â–µ –≤—Å–µ–≥–æ —Å–ª–µ–¥—É—é—Ç (—Å % —á–∞—Å—Ç–æ—Ç—ã)

9. –ö–æ–ª–ª–æ–∫–∞—Ü–∏–∏ ‚Äî —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º:
   - üîπ A2‚ÄìB1 (3‚Äì5 —à—Ç.)
   - üîπ B2‚ÄìC1 (3‚Äì5 —à—Ç.)

10. –ò–¥–∏–æ–º—ã ‚Äî –º–∞–∫—Å–∏–º—É–º 2‚Äì3 (–µ—Å–ª–∏ –µ—Å—Ç—å), –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ –Ω–µ—Ç.

11. –°–∏–Ω–æ–Ω–∏–º—ã (3 —à—Ç.) + –ø–µ—Ä–µ–≤–æ–¥ –∏ % –∑–∞–º–µ–Ω—è–µ–º–æ—Å—Ç–∏  
    –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ —Å–ª–æ–≤–æ (–∞–Ω—Ç–æ–Ω–∏–º) ‚Äî —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º

12. –ü—Ä–∏–º–µ—Ä—ã (4 —à—Ç.):
   - –∫–æ—Ä–æ—Ç–∫–∏–µ (–¥–æ 12 —Å–ª–æ–≤)
   - —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º
   - –ø–æ—è—Å–Ω–∏, –ø–æ—á–µ–º—É —Å–ª–æ–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞–∫

13. –ú–∏–Ω–∏-–¥–∏–∞–ª–æ–≥ –∏–∑ 4 —Ä–µ–ø–ª–∏–∫ ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤—ã—à–µ, –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –∂–∏–∑–Ω–∏. –£–∫–∞–∂–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–≤ –æ—Ñ–∏—Å–µ¬ª, ¬´–Ω–∞ –≤—Å—Ç—Ä–µ—á–µ¬ª, ¬´–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É¬ª).

–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ü—Ä–∏–º–µ—Ä—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º + –ø–µ—Ä–µ–≤–æ–¥.
–ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫. –†–∞–±–æ—Ç–∞–π —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–±–ª–æ–Ω—É.
"""

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def handle_word_analysis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    word = update.message.text.strip()
    user_id = update.effective_user.id

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"üìò –†–∞–∑–±–∏—Ä–∞—é —Å–ª–æ–≤–æ *{word}* –ø–æ Holla English...",
        parse_mode="Markdown"
    )

    try:
        response = await client.chat.completions.create(
            model="gpt-4o",
            messages=[{
                "role": "user",
                "content": HOLLA_PROMPT.format(word=word)
            }],
            temperature=0.5
        )
        result = response.choices[0].message.content

        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=result
        )

        # –û–∑–≤—É—á–∫–∞ —Å–∞–º–æ–≥–æ —Å–ª–æ–≤–∞
        await synthesize_and_send(
            text=word,
            chat_id=update.effective_chat.id,
            context=context
        )

        # –ó–∞–ø–∏—Å—å –≤ Google Sheets (–Ω–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫!)
        now = datetime.now().strftime("%Y-%m-%d %H:%M")
        append_to_sheet("Word_Analysis", [str(user_id), word, now])

    except Exception as e:
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–ª–æ–≤–∞. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–∑–∂–µ."
        )
        print("Word analysis error:", e)
